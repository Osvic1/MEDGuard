{% extends "base.html" %}

{% block content %}
<!-- Fixed Logout Button with Confirmation -->
<form id="logout-form" action="{{ url_for('admin_logout') }}" method="post" style="
  position:fixed;
  top:15px;
  right:20px;
  z-index:10000;
  margin:0;
">
  <input type="hidden" name="csrf" value="{{ session['csrf'] }}">
  <button type="submit" id="logout-btn" style="
    background:#dc3545;
    color:#fff;
    border:none;
    padding:8px 14px;
    border-radius:4px;
    cursor:pointer;
    font-weight:bold;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    transition:background 0.2s ease, transform 0.1s ease;
  ">
    🚪 Logout
  </button>
</form>

<!-- Session Timer Banner -->
<div id="session-timer" class="panel" style="
  background:#ffeb3b; 
  border-left:5px solid #f57c00; 
  margin-bottom:15px; 
  font-weight:bold; 
  font-size:1.1em; 
  color:#000; 
  text-align:center;
">
  ⏳ Session expires in <span id="time-left">05:00</span> due to inactivity.
</div>

<!-- ADMIN DASHBOARD HEADER -->
<div class="panel">
  <h2>🛠 Admin — Register New Drug Batch</h2>
  <p style="opacity:0.85; margin-top:0;">
    Use this form to register a new drug batch and generate its QR code instantly.
  </p>
</div>

<!-- NAVIGATION SHORTCUTS -->
<div class="panel" style="margin-bottom:15px; text-align:right;">
  <a href="{{ url_for('admin_api.admin_drugs') }}" class="btn">💊 Registered Drugs</a>
</div>

<!-- REGISTRATION FORM -->
<div class="panel">
  <h2>📦 Batch Details</h2>
  <form id="register-form" action="{{ url_for('admin_api.admin_register') }}?scroll=qr" method="post">
    <div class="inline-form" style="margin-bottom: 8px;">
      <input name="name" class="input" placeholder="Drug name" required>
      <input name="batch_number" class="input" placeholder="Batch number" required>
    </div>
    <div class="inline-form" style="margin-bottom: 8px;">
      <div style="flex:1;">
        <label for="mfg-date" style="display:block; font-weight:bold; margin-bottom:4px;">Mfg Date</label>
        <input name="mfg_date" type="date" class="input" required>
      </div>
      <div style="flex:1;">
        <label for="expiry-date" style="display:block; font-weight:bold; margin-bottom:4px;">Expiry Date</label>
        <input name="expiry_date" type="date" class="input" required>
      </div>
    </div>
    <div class="inline-form" style="margin-bottom: 8px;">
      <input name="manufacturer" class="input" placeholder="Manufacturer" required>
    </div>
    <div style="margin-top: 10px;">
      <button type="submit" class="btn btn-yellow">Register &amp; Get QR</button>
    </div>
  </form>
</div>

<!-- QR CODE DISPLAY -->
<div id="qr-result" class="panel" {% if not qr_image %}style="display:none;"{% endif %}>
  <h2>📄 Generated QR Code</h2>
  <p>Right-click and save the image below to print or share.</p>
  {% if qr_image %}
    <img src="data:image/png;base64,{{ qr_image }}" 
         alt="QR Code" 
         style="max-width:200px; background:#fff; padding:10px; border-radius:8px;">
  {% endif %}
</div>

<!-- ========================= -->
<!-- COUNTERFEIT REPORTS -->
<!-- ========================= -->
<div class="panel" id="counterfeit-reports">
  <h2>🚨 Counterfeit Reports</h2>

  <!-- Navigation buttons (now redirect to server-rendered routes) -->
  <div style="margin-bottom:15px; text-align:right;">
    <a href="{{ url_for('admin_api.admin_reports') }}?scroll=reports" id="new-reports-btn" class="btn btn-red">
      🔔 View All Reports
    </a>
    <a href="{{ url_for('admin_api.admin_reports_today') }}?scroll=reports" id="new-reports-btn-today" class="btn btn-yellow">
      Today’s Reports
    </a>
    <span id="report-count" style="margin-left:6px; background:#fff; color:#dc3545; padding:2px 6px; border-radius:50%; font-weight:bold;">
      {{ reports|length if reports is defined else 0 }}
    </span>
  </div>

  <!-- Search box (disabled for now, will need API support) -->
  <div style="margin-bottom:10px;">
    <input type="text" id="report-search" class="input" placeholder="🔍 Search reports..." disabled>
  </div>

  <!-- Filter buttons (redirect to server-rendered routes) -->
  <div style="margin-bottom:12px; text-align:right;">
    <a href="{{ url_for('admin_api.admin_reports') }}?scroll=reports" class="btn btn-outline">All Reports (History)</a>
    <a href="{{ url_for('admin_api.admin_reports_today') }}?scroll=reports" class="btn btn-yellow">Today’s Reports</a>
  </div>

  <!-- Date Range Filter (redirect to server-rendered route) -->
  <div style="margin-bottom:12px; text-align:right;">
    <label for="start" style="font-weight:bold;">From:</label>
    <input type="date" id="start" name="start" class="input" required>
    <label for="end" style="font-weight:bold;">To:</label>
    <input type="date" id="end" name="end" class="input" required>
    <a id="range-reports-btn" href="#" class="btn btn-yellow">Filter</a>
  </div>

  <!-- Reports table -->
  <table class="table" id="reports-table">
    <thead>
      <tr>
        <th data-sort="number">ID</th>
        <th data-sort="string">Drug Name</th>
        <th data-sort="string">Batch Number</th>
        <th data-sort="string">Location</th>
        <th data-sort="string">Note</th>
        <th data-sort="date">Reported On</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="reports-body">
      {# Server-render fallback: if the backend renders `reports` this will show initially #}
      {% if reports is defined and reports %}
        {% for report in reports %}
        <tr class="report-row {% if report.status == 0 %}new{% endif %}" data-id="{{ report.id }}">
          <td>{{ report.id }}</td>
          <td>{{ report.drug_name or "-" }}</td>
          <td>{{ report.batch_number }}</td>
          <td>{{ report.location or "-" }}</td>
          <td>{{ report.note or "-" }}</td>
          <td>{{ report.reported_on }}</td>
          <td>
            {% if report.status == 0 %}
              <span class="badge badge-new">New</span>
            {% else %}
              <span class="badge badge-checked">Checked</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" style="text-align:center;">No reports submitted yet.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Session Timeout Modal -->
<div id="timeout-modal" style="
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    max-width:300px;
    text-align:center;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
  ">
    <h3>⚠️ Session Expiring</h3>
    <p>Your session will expire in <span id="modal-time-left">30</span> seconds.</p>
    <button id="stay-logged-in" class="btn btn-yellow" style="margin-top:10px;">Stay Logged In</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='admin.js') }}"></script>
<script src="{{ url_for('static', filename='admin_timer.js') }}"></script>

<style>
.blink { animation: blink 1s infinite; }
@keyframes blink { 50% { opacity: 0.4; } }

.btn-red { background: #dc3545; color: #fff; border: none; padding: 8px 14px; border-radius: 4px; }
.btn-yellow { background: #ffeb3b; color: #000; border: none; padding: 8px 14px; border-radius: 4px; }
.btn-outline { background: transparent; color: #000; border: 1px solid #000; padding: 7px 13px; border-radius: 4px; }

.badge { display:inline-block; padding:2px 8px; border-radius:12px; font-weight:600; font-size:12px; }
.badge-new { background:#fff3cd; color:#856404; border:1px solid #ffeeba; }      /* yellow */
.badge-checked { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }  /* green */
.report-row.new { background:#fffdf3; } /* optional highlight for new rows */
</style>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const rangeBtn = document.getElementById("range-reports-btn");

    // Handle date range filter redirect with scroll
    rangeBtn.addEventListener("click", () => {
      const start = startInput.value;
      const end = endInput.value;
      if (!start || !end) {
        alert("Please select start and end dates");
        return;
      }
      window.location.href = `{{ url_for('admin_api.admin_reports_range') }}?start=${start}&end=${end}&scroll=reports`;
    });

    // Handle scroll on page load based on URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get('scroll');
    if (scrollTo) {
      if (scrollTo === 'qr') {
        document.getElementById('qr-result').scrollIntoView({ behavior: 'smooth' });
      } else if (scrollTo === 'reports') {
        document.getElementById('counterfeit-reports').scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
</script>
{% endblock %}